# 2. 顶层设计

Ext4文件系统是由众多块组构成。为了减少由于碎片造成的性能困难，块分配器会非常努力地将每个文件的块保留在同一组中，从而减少寻道时间。块组的大小在 ```sb.s_blocks_per_group``` 中指定，也可以由 ```8 * block_size_in_bytes```算出来。块大小默认为**4KB**，每个块组包含了**32768** 个块，所以大小为**128MB**。块组的数量可以由存储设备的大小除以当个块组大小得出来。  
ext4 中的所有字段都按小端写入磁盘，但是，jbd2（日志）中的所有字段都按大端写入磁盘。

## 2.1. 块

ext4 以"块"为单位分配存储空间。块是介于 1KiB 和 64KiB 之间的一组扇区，扇区数必须是 2 的指数倍。比块更大的单位是由块组成的块组。块大小在 ```mkfs``` 时指定，通常为 4KiB。如果块大小大于页的大小（比如在 只有 4KiB页大小的i386上创建 64KiB 大小的块），则可能会遇到安装问题。默认情况下，文件系统可以包含 2^32 个块。如果启用了"64 位"功能，则文件系统可以有 2^64 个块。

## 2.2. 块组的布局

标准的块组布局大致如下分布:
![](/assets/block_group_layout.png)

块组0的情况比较特殊，前1024个字节是保留字节以允许安装x86启动扇区和其他用途。超级块将以偏移量 1024 字节开始，通常为块0。但是，如果由于某种原因块大小等于1024字节，则超级块为块1。对于其他块组则没有偏移。

ext4驱动程序主要使用块组0中的超级块和组描述符。超级块和组描述符的冗余副本将写入磁盘上的某些块组，以防磁盘开头被破坏，尽管并非所有块组都必须承载冗余副本（有关详细信息，请参阅以下段落）。如果组没有冗余副本，则块组以```data block bitmap```开始。此外，当文件系统新格式化时，mkfs 将在块组描述符之后和块位映射开始之前分配" ```reserve GDT block``` "空间，以允许文件系统将来扩展。默认情况下，允许文件系统的大小比原始文件系统大小增加 1024 倍。


inode 表的位置由```grp.bg_inode_table_*```表示。拥有足够大的连续的块，足以包含 ```sb.s_inodes_per_group * sb.s_inode_size```字节大小。

对于块组中各个项的排序，通常确定超级块和组描述符表（如果存在）将位于块组的开头。位图和 inode 表可以是任意位置，并且位图很有可能位于 inode 表之后，或者两者都位于不同的组中 （flex_bg）。剩余空间用于文件数据块、间接块映射、范围树块和扩展属性。

## 2.3. 灵活的块组
>>
Starting in ext4, there is a new feature called flexible block groups (flex_bg). In a flex_bg, several block groups are tied together as one logical block group; the bitmap spaces and the inode table space in the first block group of the flex_bg are expanded to include the bitmaps and inode tables of all other block groups in the flex_bg. For example, if the flex_bg size is 4, then group 0 will contain (in order) the superblock, group descriptors, data block bitmaps for groups 0-3, inode bitmaps for groups 0-3, inode tables for groups 0-3, and the remaining space in group 0 is for file data. The effect of this is to group the block metadata close together for faster loading, and to enable large files to be continuous on disk. Backup copies of the superblock and group descriptors are always at the beginning of block groups, even if flex_bg is enabled. The number of block groups that make up a flex_bg is given by 2 ^ sb.s_log_groups_per_flex.

从 ext4 开始，有一个称为灵活块组 （flex_bg） 的新功能。在 flex_bg 中，多个块组作为一个逻辑块组绑定在一起;flex_bg 的第一个块组中的位图空间和 inode 表空间被展开，以包括 flex_bg 中所有其他块组的位图和 inode 表。例如，如果 flex_bg 大小为 4，则组 0 将包含（按顺序）超级块、组描述符、组 0-3 的数据块位图、组 0-3 的 inode 位图、组 0-3 的 inode 表，组 0 中的剩余空间用于文件数据。这样做的效果是将块元数据紧密地组合在一起以加快加载速度，并使大型文件能够在磁盘上连续运行。超级块和组描述符的备份副本始终位于块组的开头，即使启用了 flex_bg 也是如此。构成 flex_bg 的块组数由 2 个 _ sb.s_log_组_per_flex 给出。













