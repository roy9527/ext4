# 2. 顶层设计

Ext4文件系统是由众多块组构成。为了减少由于碎片造成的性能困难，块分配器会非常努力地将每个文件的块保留在同一组中，从而减少寻道时间。块组的大小在 ```sb.s_blocks_per_group``` 中指定，也可以由 ```8 * block_size_in_bytes```算出来。块大小默认为**4KB**，每个块组包含了**32768** 个块，所以大小为**128MB**。块组的数量可以由存储设备的大小除以当个块组大小得出来。  
ext4 中的所有字段都按小端写入磁盘，但是，jbd2（日志）中的所有字段都按大端写入磁盘。

## 2.1. 块

ext4 以"块"为单位分配存储空间。块是介于 1KiB 和 64KiB 之间的一组扇区，扇区数必须是 2 的指数倍。比块更大的单位是由块组成的块组。块大小在 ```mkfs``` 时指定，通常为 4KiB。如果块大小大于页的大小（比如在 只有 4KiB页大小的i386上创建 64KiB 大小的块），则可能会遇到安装问题。默认情况下，文件系统可以包含 2^32 个块。如果启用了"64 位"功能，则文件系统可以有 2^64 个块。

## 2.2. 块组的布局

标准的块组布局大致如下分布:
![](/assets/block_group_layout.png)

>>
For the special case of block group 0, the first 1024 bytes are unused, to allow for the installation of x86 boot sectors and other oddities. The superblock will start at offset 1024 bytes, whichever block that happens to be (usually 0). However, if for some reason the block size = 1024, then block 0 is marked in use and the superblock goes in block 1. For all other block groups, there is no padding.

块组0的情况比较特殊，前1024个字节是保留字节以允许安装x86启动扇区和其他用途。超级块将以偏移量 1024 字节开始，通常为块0。但是，如果由于某种原因块大小等于1024字节，则超级块为块1。对于其他块组则没有偏移。

ext4驱动程序主要使用块组0中的超级块和组描述符。超级块和组描述符的冗余副本将写入磁盘上的某些块组，以防磁盘开头被破坏，尽管并非所有块组都必须承载冗余副本（有关详细信息，请参阅以下段落）。如果组没有冗余副本，则块组以```data block bitmap```开始。此外，当文件系统新格式化时，mkfs 将在块组描述符之后和块位映射开始之前分配" ```reserve GDT block``` "空间，以允许文件系统将来扩展。默认情况下，允许文件系统的大小比原始文件系统大小增加 1024 倍。


inode 表的位置由 grp.bg_inode_table_表示。它是足够大的块的连续范围，足以包含 sb.s_innodes_per 组 = sb.s_inode_size 字节。

对于块组中的项排序，通常确定超级块和组描述符表（如果存在）将位于块组的开头。位图和 inode 表可以是任意位置，并且位图很有可能位于 inode 表之后，或者两者都位于不同的组中 （flex_bg）。剩余空间用于文件数据块、间接块映射、范围树块和扩展属性。

The ext4 driver primarily works with the superblock and the group descriptors that are found in block group 0. Redundant copies of the superblock and group descriptors are written to some of the block groups across the disk in case the beginning of the disk gets trashed, though not all block groups necessarily host a redundant copy (see following paragraph for more details). If the group does not have a redundant copy, the block group begins with the data block bitmap. Note also that when the filesystem is freshly formatted, mkfs will allocate “reserve GDT block” space after the block group descriptors and before the start of the block bitmaps to allow for future expansion of the filesystem. By default, a filesystem is allowed to increase in size by a factor of 1024x over the original filesystem size.

The location of the inode table is given by grp.bg_inode_table_*. It is continuous range of blocks large enough to contain sb.s_inodes_per_group * sb.s_inode_size bytes.

As for the ordering of items in a block group, it is generally established that the super block and the group descriptor table, if present, will be at the beginning of the block group. The bitmaps and the inode table can be anywhere, and it is quite possible for the bitmaps to come after the inode table, or for both to be in different groups (flex_bg). Leftover space is used for file data blocks, indirect block maps, extent tree blocks, and extended attributes.